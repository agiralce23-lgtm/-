<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Camera + Grayscale Preview</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header { padding: 12px 14px; border-bottom: 1px solid rgba(127,127,127,.35); }
    .wrap { max-width: 900px; margin: 0 auto; padding: 12px 14px 20px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button, select, label { font-size: 14px; }
    button { padding: 8px 12px; cursor: pointer; }
    .stack { display: grid; gap: 12px; margin-top: 12px; }
    .panel { border: 1px solid rgba(127,127,127,.35); border-radius: 10px; overflow: hidden; }
    .panel h2 { margin: 0; padding: 10px 12px; font-size: 14px; border-bottom: 1px solid rgba(127,127,127,.25); }
    .content { padding: 10px 12px; }
    video, canvas { width: 100%; height: auto; display: block; background: #000; }
    .hint { opacity: .8; font-size: 12px; line-height: 1.4; }
    .err { color: #d33; white-space: pre-wrap; font-size: 12px; }
    .tiny { font-size: 12px; opacity: .8; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <button id="btnStart">カメラ開始</button>
        <button id="btnStop" disabled>停止</button>

        <label>
          カメラ:
          <select id="selDevice"></select>
        </label>

        <label>
          <input type="checkbox" id="chkMirror" checked>
          ミラー表示
        </label>

        <span class="tiny" id="status">未開始</span>
      </div>
      <div class="hint">
        上：撮影（video）／ 下：グレースケール（canvas）<br>
        ※動かない場合は「localhost で開く」必要があります（下の説明参照）。
      </div>
      <div class="err" id="err"></div>
    </div>
  </header>

  <main class="wrap">
    <div class="stack">
      <section class="panel">
        <h2>撮影画面</h2>
        <div class="content">
          <video id="video" playsinline autoplay muted></video>
        </div>
      </section>

      <section class="panel">
        <h2>グレースケール</h2>
        <div class="content">
          <canvas id="gray"></canvas>
        </div>
      </section>
    </div>
  </main>

  <script>
    const video = document.getElementById('video');
    const grayCanvas = document.getElementById('gray');
    const grayCtx = grayCanvas.getContext('2d', { willReadFrequently: true });

    const btnStart = document.getElementById('btnStart');
    const btnStop  = document.getElementById('btnStop');
    const selDevice = document.getElementById('selDevice');
    const chkMirror = document.getElementById('chkMirror');
    const statusEl  = document.getElementById('status');
    const errEl     = document.getElementById('err');

    let stream = null;
    let rafId = 0;

    function setStatus(t){ statusEl.textContent = t; }
    function setError(e){
      errEl.textContent = e ? String(e) : '';
    }

    function applyMirror() {
      const on = chkMirror.checked;
      video.style.transform = on ? 'scaleX(-1)' : 'none';
      grayCanvas.style.transform = on ? 'scaleX(-1)' : 'none';
    }
    chkMirror.addEventListener('change', applyMirror);
    applyMirror();

    async function listDevices() {
      selDevice.innerHTML = '';
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      cams.forEach((d, i) => {
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.textContent = d.label || `Camera ${i+1}`;
        selDevice.appendChild(opt);
      });
    }

    function stopStream() {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = 0;

      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      setStatus('停止');
      btnStop.disabled = true;
      btnStart.disabled = false;
    }

    function renderLoop() {
      const w = video.videoWidth | 0;
      const h = video.videoHeight | 0;
      if (w > 0 && h > 0) {
        if (grayCanvas.width !== w || grayCanvas.height !== h) {
          grayCanvas.width = w;
          grayCanvas.height = h;
        }

        // video → canvas
        grayCtx.drawImage(video, 0, 0, w, h);

        // grayscale
        const img = grayCtx.getImageData(0, 0, w, h);
        const data = img.data;
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i], g = data[i+1], b = data[i+2];
          // 輝度（標準的な加重平均）
          const y = (0.299*r + 0.587*g + 0.114*b) | 0;
          data[i] = data[i+1] = data[i+2] = y;
          // data[i+3] は alpha
        }
        grayCtx.putImageData(img, 0, 0);
      }
      rafId = requestAnimationFrame(renderLoop);
    }

    async function startCamera(deviceId) {
      setError('');
      stopStream();

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('このブラウザは getUserMedia に対応していません。Chrome/Edge の新しめで試してください。');
      }

      const constraints = {
        audio: false,
        video: {
          deviceId: deviceId ? { exact: deviceId } : undefined,
          width:  { ideal: 1280 },
          height: { ideal: 720 }
        }
      };

      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      await new Promise(resolve => {
        if (video.readyState >= 1) return resolve();
        video.onloadedmetadata = () => resolve();
      });
      await video.play();

      setStatus('稼働中');
      btnStop.disabled = false;
      btnStart.disabled = true;

      // 権限取得後に device label が取れるので再取得
      await listDevices();
      if (deviceId) selDevice.value = deviceId;

      renderLoop();
    }

    btnStart.addEventListener('click', async () => {
      try {
        setStatus('起動中...');
        await startCamera(selDevice.value || null);
      } catch (e) {
        setStatus('開始失敗');
        setError(e);
        stopStream();
      }
    });

    btnStop.addEventListener('click', () => stopStream());

    selDevice.addEventListener('change', async () => {
      if (!stream) return; // 未開始なら選ぶだけ
      try {
        setStatus('切替中...');
        await startCamera(selDevice.value);
      } catch (e) {
        setStatus('切替失敗');
        setError(e);
        stopStream();
      }
    });

    // 初期化：デバイス一覧だけ先に試す（権限前は label が空でもOK）
    (async () => {
      try {
        await listDevices();
      } catch (e) {
        // enumerateDevices は https/localhost でも権限前に通ることが多いけど環境差あり
        setError(e);
      }
    })();
  </script>
</body>
</html>
